http:
  enabled: true
  address: 0.0.0.0:4195
  root_path: /bento
  debug_endpoints: true

input:
  label: ""
  broker:
    inputs:
      - mongodb:
          url: "mongodb://localhost:27017/?replicaSet=rs0&directConnection=true"
          database: "CustomersDB"
          collection: "outbox"
          operation: find
          json_marshal_mode: canonical
          query: |
            root.status = "pending"
          auto_replay_nacks: true
          batch_size: 1000
          sort: {"created_at": 1}

pipeline:
  processors:
    - mapping: |
        root.name = this.payload.name
        root.email = this.payload.email
        root.updated_at = now()
        root.status = "true"

    - mongodb:
        url: "mongodb://localhost:27017/?replicaSet=rs0&directConnection=true"
        database: "OrderingDB"
        collection: "projection_customers"
        operation: update-one
        filter_map: |
          root.email = this.email
        document_map: |
          root = {"$set": this}
        upsert: true
        write_concern:
          w: 1
          j: true
          w_timeout: "10s"

output:
  label: ""
  stdout:
    codec: lines
